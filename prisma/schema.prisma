// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

enum UserRole {
  EMPLOYEE
  HR
}

enum RelationshipType {
  DIRECT_REPORT
  TEAM_LEAD
  PEER
  C_LEVEL
  HR
  SELF
}

enum QuestionType {
  RATING
  TEXT
}

enum EmailStatus {
  PENDING
  SENT
  FAILED
}

enum LeaveType {
  CASUAL
  SICK
  ANNUAL
}

enum LeaveStatus {
  PENDING           // Waiting for approvals
  LEAD_APPROVED     // Lead approved, waiting for HR
  HR_APPROVED       // HR approved, waiting for Lead  
  APPROVED          // Both approved
  REJECTED          // Either rejected
  CANCELLED         // Employee cancelled
}

model User {
  id           String   @id @default(cuid())
  name         String
  email        String?  @unique
  passwordHash    String?  // Hashed password for authentication
  passwordVersion Int      @default(0)
  department      String?
  position     String?
  role         UserRole @default(EMPLOYEE)
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt
  
  // Org chart position (optional - used to save custom positions)
  chartX      Float?
  chartY      Float?

  // Relations
  evaluatorMappings   EvaluatorMapping[] @relation("Evaluator")
  evaluateeMappings   EvaluatorMapping[] @relation("Evaluatee")
  evaluations         Evaluation[]
  weightages          Weightage[]
  reports              Report[]
  emailQueue           EmailQueue[]
  
  // Leave management relations
  leaveRequests       LeaveRequest[]     @relation("LeaveEmployee")
  leaveCovering       LeaveRequest[]     @relation("LeaveCover")
  leaveBalances       LeaveBalance[]

  @@index([name])
  @@index([email])
}

model EvaluatorMapping {
  id               String           @id @default(cuid())
  evaluatorId      String
  evaluateeId      String
  relationshipType RelationshipType
  isSelfEvaluation Boolean          @default(false) // Flag for self-evaluations
  createdAt        DateTime         @default(now())

  evaluator User @relation("Evaluator", fields: [evaluatorId], references: [id], onDelete: Cascade)
  evaluatee User @relation("Evaluatee", fields: [evaluateeId], references: [id], onDelete: Cascade)

  @@unique([evaluatorId, evaluateeId, relationshipType])
  @@index([evaluatorId])
  @@index([evaluateeId])
}

model EvaluationQuestion {
  id               String           @id @default(cuid())
  relationshipType RelationshipType
  questionText     String
  questionType     QuestionType     @default(RATING)
  maxRating        Int              @default(4)
  orderIndex       Int
  createdAt        DateTime         @default(now())
  updatedAt        DateTime         @updatedAt

  evaluations Evaluation[]

  @@unique([relationshipType, orderIndex])
  @@index([relationshipType, orderIndex])
}

model EvaluationPeriod {
  id        String   @id @default(cuid())
  name      String   // e.g., "Q3 2025"
  startDate DateTime
  endDate   DateTime
  isActive  Boolean  @default(true)
  isLocked  Boolean  @default(false) // Prevents new submissions when locked
  reminderSent Boolean @default(false) // Track if deadline reminder was sent
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  reports Report[]
  evaluations Evaluation[]

  @@index([isActive])
}

model Evaluation {
  id           String    @id @default(cuid())
  evaluatorId String
  evaluateeId String
  questionId   String
  periodId     String
  ratingValue  Int?
  textResponse String?
  submittedAt  DateTime?
  createdAt    DateTime  @default(now())
  updatedAt    DateTime  @updatedAt

  evaluator User              @relation(fields: [evaluatorId], references: [id], onDelete: Cascade)
  question  EvaluationQuestion @relation(fields: [questionId], references: [id], onDelete: Cascade)
  period    EvaluationPeriod   @relation(fields: [periodId], references: [id], onDelete: Cascade)

  @@unique([evaluatorId, evaluateeId, questionId, periodId])
  @@index([evaluatorId])
  @@index([evaluateeId])
  @@index([periodId])
}

model Weightage {
  id                 String           @id @default(cuid())
  employeeId         String
  relationshipType   RelationshipType
  weightagePercentage Float
  createdAt          DateTime         @default(now())
  updatedAt          DateTime         @updatedAt

  employee User @relation(fields: [employeeId], references: [id], onDelete: Cascade)

  @@unique([employeeId, relationshipType])
  @@index([employeeId])
}

model Report {
  id           String   @id @default(cuid())
  employeeId   String
  periodId     String
  overallScore Float
  breakdownJson Json    // Store detailed breakdown as JSON
  isAnonymized Boolean  @default(false) // Whether evaluator names are hidden
  generatedAt  DateTime @default(now())

  employee User            @relation(fields: [employeeId], references: [id], onDelete: Cascade)
  period   EvaluationPeriod @relation(fields: [periodId], references: [id], onDelete: Cascade)
  emailQueue EmailQueue[]

  @@unique([employeeId, periodId])
  @@index([employeeId])
  @@index([periodId])
}

model EmailQueue {
  id         String      @id @default(cuid())
  employeeId String
  reportId   String?
  emailStatus EmailStatus @default(PENDING)
  scheduledAt DateTime?
  sentAt     DateTime?
  errorMessage String?
  createdAt  DateTime    @default(now())
  updatedAt  DateTime    @updatedAt

  employee User    @relation(fields: [employeeId], references: [id], onDelete: Cascade)
  report   Report? @relation(fields: [reportId], references: [id], onDelete: SetNull)

  @@index([emailStatus])
  @@index([employeeId])
}

// Leave Management
model LeaveRequest {
  id              String      @id @default(cuid())
  employeeId      String
  leaveType       LeaveType
  startDate       DateTime
  endDate         DateTime
  reason          String
  transitionPlan  String      // Tasks and handover details
  coverPersonId   String?     // Who covers their tasks
  additionalNotifyIds Json?   // Array of user IDs to CC on email (notification only, not approval)
  status          LeaveStatus @default(PENDING)
  
  leadApprovedBy  String?     // Lead who approved
  leadApprovedAt  DateTime?
  leadComment     String?
  
  hrApprovedBy    String?     // HR who approved
  hrApprovedAt    DateTime?
  hrComment       String?
  
  rejectedBy      String?
  rejectedAt      DateTime?
  rejectionReason String?
  
  createdAt       DateTime    @default(now())
  updatedAt       DateTime    @updatedAt
  
  employee        User        @relation("LeaveEmployee", fields: [employeeId], references: [id], onDelete: Cascade)
  coverPerson     User?       @relation("LeaveCover", fields: [coverPersonId], references: [id], onDelete: SetNull)

  @@index([employeeId])
  @@index([status])
  @@index([startDate, endDate])
}

model LeaveBalance {
  id          String   @id @default(cuid())
  employeeId  String
  year        Int
  casualDays  Int      @default(10)
  sickDays    Int      @default(6)
  annualDays  Int      @default(14)
  casualUsed  Int      @default(0)
  sickUsed    Int      @default(0)
  annualUsed  Int      @default(0)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  
  employee    User     @relation(fields: [employeeId], references: [id], onDelete: Cascade)
  
  @@unique([employeeId, year])
  @@index([employeeId])
}
